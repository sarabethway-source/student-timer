<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pomodoro Focus Tracker</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-dark: #0a0a0f;
      --bg-card: #12121a;
      --bg-elevated: #1a1a24;
      --accent: #ff6b6b;
      --accent-glow: rgba(255, 107, 107, 0.3);
      --success: #4ecdc4;
      --warning: #ffe66d;
      --text: #ffffff;
      --text-muted: #8a8a9a;
      --border: rgba(255, 255, 255, 0.08);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Outfit', sans-serif;
      background: var(--bg-dark);
      color: var(--text);
      min-height: 100vh;
      background-image: 
        radial-gradient(ellipse at 20% 0%, rgba(255, 107, 107, 0.08) 0%, transparent 50%),
        radial-gradient(ellipse at 80% 100%, rgba(78, 205, 196, 0.06) 0%, transparent 50%);
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    /* Header */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 0 40px;
      border-bottom: 1px solid var(--border);
      margin-bottom: 40px;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 24px;
      font-weight: 700;
    }

    .logo-icon {
      width: 48px;
      height: 48px;
      background: linear-gradient(145deg, var(--accent), #c0392b);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .user-name {
      color: var(--text-muted);
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 12px;
      font-family: inherit;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-primary {
      background: linear-gradient(145deg, var(--accent), #c0392b);
      color: white;
      box-shadow: 0 4px 20px var(--accent-glow);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 30px var(--accent-glow);
    }

    .btn-secondary {
      background: var(--bg-elevated);
      color: var(--text);
      border: 1px solid var(--border);
    }

    .btn-secondary:hover {
      background: var(--bg-card);
    }

    /* Auth Forms */
    .auth-container {
      max-width: 440px;
      margin: 80px auto;
    }

    .auth-card {
      background: var(--bg-card);
      border-radius: 24px;
      padding: 48px;
      border: 1px solid var(--border);
    }

    .auth-title {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 8px;
      text-align: center;
    }

    .auth-subtitle {
      color: var(--text-muted);
      text-align: center;
      margin-bottom: 32px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      color: var(--text-muted);
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .form-input {
      width: 100%;
      padding: 14px 18px;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 12px;
      color: var(--text);
      font-family: inherit;
      font-size: 16px;
      transition: border-color 0.2s;
    }

    .form-input:focus {
      outline: none;
      border-color: var(--accent);
    }

    .form-input::placeholder {
      color: var(--text-muted);
    }

    .auth-switch {
      text-align: center;
      margin-top: 24px;
      color: var(--text-muted);
    }

    .auth-switch a {
      color: var(--accent);
      text-decoration: none;
      font-weight: 600;
    }

    .error-message {
      background: rgba(255, 107, 107, 0.1);
      border: 1px solid rgba(255, 107, 107, 0.3);
      color: var(--accent);
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 14px;
    }

    /* Agreement Page */
    .agreement-card {
      max-width: 640px;
      margin: 60px auto;
      background: var(--bg-card);
      border-radius: 24px;
      padding: 48px;
      border: 1px solid var(--border);
    }

    .agreement-icon {
      width: 80px;
      height: 80px;
      background: linear-gradient(145deg, var(--success), #3db8ad);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 40px;
      margin: 0 auto 24px;
    }

    .agreement-title {
      font-size: 28px;
      font-weight: 700;
      text-align: center;
      margin-bottom: 24px;
    }

    .agreement-content {
      background: var(--bg-elevated);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 24px;
      max-height: 300px;
      overflow-y: auto;
    }

    .agreement-content h3 {
      color: var(--accent);
      margin-bottom: 12px;
      font-size: 16px;
    }

    .agreement-content p {
      color: var(--text-muted);
      line-height: 1.7;
      margin-bottom: 16px;
    }

    .agreement-content ul {
      color: var(--text-muted);
      margin-left: 20px;
      line-height: 1.8;
    }

    .checkbox-group {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      margin-bottom: 24px;
    }

    .checkbox-group input[type="checkbox"] {
      width: 24px;
      height: 24px;
      accent-color: var(--accent);
      margin-top: 2px;
    }

    .checkbox-label {
      color: var(--text);
      line-height: 1.5;
    }

    /* Dashboard */
    .dashboard-grid {
      display: grid;
      grid-template-columns: 280px 1fr;
      gap: 24px;
    }

    .sidebar {
      background: var(--bg-card);
      border-radius: 20px;
      padding: 24px;
      border: 1px solid var(--border);
      height: fit-content;
      position: sticky;
      top: 20px;
    }

    .sidebar-title {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 16px;
    }

    .student-list {
      list-style: none;
    }

    .student-item {
      padding: 14px 16px;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s;
      margin-bottom: 4px;
    }

    .student-item:hover {
      background: var(--bg-elevated);
    }

    .student-item.active {
      background: var(--accent);
      color: white;
    }

    .student-item-name {
      font-weight: 600;
      margin-bottom: 4px;
    }

    .student-item-meta {
      font-size: 12px;
      color: var(--text-muted);
    }

    .student-item.active .student-item-meta {
      color: rgba(255, 255, 255, 0.7);
    }

    .main-content {
      background: var(--bg-card);
      border-radius: 20px;
      padding: 32px;
      border: 1px solid var(--border);
    }

    .content-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 32px;
    }

    .content-title {
      font-size: 24px;
      font-weight: 700;
    }

    .screenshot-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
    }

    .screenshot-card {
      background: var(--bg-elevated);
      border-radius: 16px;
      overflow: hidden;
      border: 1px solid var(--border);
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .screenshot-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.3);
    }

    .screenshot-image {
      width: 100%;
      aspect-ratio: 16/10;
      object-fit: cover;
      cursor: pointer;
    }

    .screenshot-info {
      padding: 16px;
    }

    .screenshot-time {
      font-weight: 600;
      margin-bottom: 4px;
    }

    .screenshot-url {
      font-size: 12px;
      color: var(--text-muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .btn-delete {
      background: rgba(255, 107, 107, 0.1);
      border: 1px solid rgba(255, 107, 107, 0.3);
      color: var(--accent);
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 12px;
      cursor: pointer;
      margin-top: 8px;
      transition: all 0.2s;
    }

    .btn-delete:hover {
      background: rgba(255, 107, 107, 0.2);
    }

    /* Student Dashboard */
    .status-card {
      background: linear-gradient(145deg, var(--accent), #c0392b);
      border-radius: 20px;
      padding: 32px;
      margin-bottom: 24px;
      text-align: center;
    }

    .status-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }

    .status-title {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .status-subtitle {
      opacity: 0.8;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      margin-bottom: 24px;
    }

    .stat-card {
      background: var(--bg-elevated);
      border-radius: 16px;
      padding: 24px;
      text-align: center;
      border: 1px solid var(--border);
    }

    .stat-value {
      font-size: 32px;
      font-weight: 700;
      color: var(--accent);
    }

    .stat-label {
      font-size: 13px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    /* Lightbox */
    .lightbox {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.95);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s;
    }

    .lightbox.visible {
      opacity: 1;
      visibility: visible;
    }

    .lightbox img {
      max-width: 90%;
      max-height: 90%;
      border-radius: 8px;
    }

    .lightbox-close {
      position: absolute;
      top: 20px;
      right: 20px;
      width: 48px;
      height: 48px;
      background: var(--bg-elevated);
      border: none;
      border-radius: 50%;
      color: white;
      font-size: 24px;
      cursor: pointer;
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-muted);
    }

    .empty-state-icon {
      font-size: 64px;
      margin-bottom: 16px;
    }

    /* Hide all pages by default */
    .page { display: none; }
    .page.active { display: block; }

    /* Responsive */
    @media (max-width: 768px) {
      .dashboard-grid {
        grid-template-columns: 1fr;
      }
      
      .sidebar {
        position: static;
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div id="app"></div>

  <!-- Lightbox -->
  <div class="lightbox" id="lightbox" onclick="closeLightbox()">
    <button class="lightbox-close" onclick="closeLightbox()">√ó</button>
    <img id="lightbox-img" src="" alt="Screenshot">
  </div>

  <script>
    // API Base URL
    const API_URL = '';

    // State
    let currentUser = null;
    let authToken = localStorage.getItem('pomodoroToken');

    // Initialize app
    async function init() {
      if (authToken) {
        try {
          const res = await fetch(`${API_URL}/api/me`, {
            headers: { 'Authorization': `Bearer ${authToken}` }
          });
          if (res.ok) {
            currentUser = await res.json();
            if (currentUser.role === 'teacher') {
              showTeacherDashboard();
            } else if (!currentUser.agreedToTerms) {
              showAgreementPage();
            } else {
              showStudentDashboard();
            }
            return;
          }
        } catch (e) {
          console.error('Auth check failed:', e);
        }
        localStorage.removeItem('pomodoroToken');
        authToken = null;
      }
      showLoginPage();
    }

    // Render helpers
    function render(html) {
      document.getElementById('app').innerHTML = html;
    }

    // Login Page
    function showLoginPage() {
      render(`
        <div class="auth-container">
          <div class="auth-card">
            <div class="logo" style="justify-content: center; margin-bottom: 32px;">
              <div class="logo-icon">üçÖ</div>
              <span>Focus Tracker</span>
            </div>
            <h1 class="auth-title">Welcome Back</h1>
            <p class="auth-subtitle">Sign in to continue your focus journey</p>
            
            <div id="error-msg" class="error-message" style="display: none;"></div>
            
            <form onsubmit="handleLogin(event)">
              <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" id="login-email" class="form-input" placeholder="you@school.edu" required>
              </div>
              <div class="form-group">
                <label class="form-label">Password</label>
                <input type="password" id="login-password" class="form-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
              </div>
              <button type="submit" class="btn btn-primary" style="width: 100%;">Sign In</button>
            </form>
            
            <p class="auth-switch">
              Don't have an account? <a href="#" onclick="showRegisterPage()">Sign up</a>
            </p>
            <p class="auth-switch" style="margin-top: 12px;">
              <a href="#" onclick="showTeacherLoginPage()">Teacher Login</a>
            </p>
          </div>
        </div>
      `);
    }

    // Teacher Login Page (password only)
    function showTeacherLoginPage() {
      render(`
        <div class="auth-container">
          <div class="auth-card">
            <div class="logo" style="justify-content: center; margin-bottom: 32px;">
              <div class="logo-icon">üçÖ</div>
              <span>Focus Tracker</span>
            </div>
            <h1 class="auth-title">Teacher Access</h1>
            <p class="auth-subtitle">Enter the admin password to view student activity</p>
            
            <div id="error-msg" class="error-message" style="display: none;"></div>
            
            <form onsubmit="handleTeacherLogin(event)">
              <div class="form-group">
                <label class="form-label">Admin Password</label>
                <input type="password" id="teacher-password" class="form-input" placeholder="Enter password" required autofocus>
              </div>
              <button type="submit" class="btn btn-primary" style="width: 100%;">Access Dashboard</button>
            </form>
            
            <p class="auth-switch">
              <a href="#" onclick="showLoginPage()">‚Üê Back to Student Login</a>
            </p>
          </div>
        </div>
      `);
    }

    // Register Page
    function showRegisterPage() {
      render(`
        <div class="auth-container">
          <div class="auth-card">
            <div class="logo" style="justify-content: center; margin-bottom: 32px;">
              <div class="logo-icon">üçÖ</div>
              <span>Focus Tracker</span>
            </div>
            <h1 class="auth-title">Create Account</h1>
            <p class="auth-subtitle">Join your class's focus tracking</p>
            
            <div id="error-msg" class="error-message" style="display: none;"></div>
            
            <form onsubmit="handleRegister(event)">
              <div class="form-group">
                <label class="form-label">Full Name</label>
                <input type="text" id="register-name" class="form-input" placeholder="Your full name" required>
              </div>
              <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" id="register-email" class="form-input" placeholder="you@school.edu" required>
              </div>
              <div class="form-group">
                <label class="form-label">Password</label>
                <input type="password" id="register-password" class="form-input" placeholder="Create a password" required minlength="6">
              </div>
              <button type="submit" class="btn btn-primary" style="width: 100%;">Create Account</button>
            </form>
            
            <p class="auth-switch">
              Already have an account? <a href="#" onclick="showLoginPage()">Sign in</a>
            </p>
          </div>
        </div>
      `);
    }

    // Agreement Page
    function showAgreementPage() {
      render(`
        <div class="container">
          <div class="agreement-card">
            <div class="agreement-icon">üìã</div>
            <h1 class="agreement-title">Focus Tracking Agreement</h1>
            
            <div class="agreement-content">
              <h3>What This Extension Does</h3>
              <p>The Pomodoro Focus Tracker helps you and your teachers monitor your productivity during class time. Here's what you need to know:</p>
              
              <h3>Screenshot Monitoring</h3>
              <ul>
                <li>Every <strong>10 minutes</strong>, a screenshot of your current browser tab will be captured</li>
                <li>Screenshots are taken automatically in the background</li>
                <li>The URL and title of the page are also recorded</li>
              </ul>
              
              <h3>Who Can See Your Screenshots</h3>
              <ul>
                <li><strong>You</strong> can view all your own screenshots</li>
                <li><strong>Your teachers</strong> (administrators) can view your screenshots to help you stay focused</li>
                <li>Other students <strong>cannot</strong> see your screenshots</li>
              </ul>
              
              <h3>When Monitoring Happens</h3>
              <ul>
                <li>Monitoring is active whenever the extension is installed and running</li>
                <li>This includes during your scheduled Pomodoro sessions</li>
              </ul>
              
              <h3>Your Privacy</h3>
              <ul>
                <li>Screenshots are stored securely on school servers</li>
                <li>This data is used only for educational productivity purposes</li>
                <li>You can see your activity history at any time</li>
              </ul>
            </div>
            
            <div class="checkbox-group">
              <input type="checkbox" id="agree-checkbox">
              <label for="agree-checkbox" class="checkbox-label">
                I understand that my browser activity will be monitored through periodic screenshots, 
                and that my teachers can view this information to help me stay focused and productive.
              </label>
            </div>
            
            <button class="btn btn-primary" style="width: 100%;" onclick="handleAcceptTerms()" id="accept-btn" disabled>
              I Understand & Accept
            </button>
          </div>
        </div>
      `);

      document.getElementById('agree-checkbox').addEventListener('change', (e) => {
        document.getElementById('accept-btn').disabled = !e.target.checked;
      });
    }

    // Student Dashboard
    async function showStudentDashboard() {
      const screenshots = await fetchJSON('/api/my-screenshots');
      const today = screenshots.filter(s => {
        const d = new Date(s.captured_at);
        const now = new Date();
        return d.toDateString() === now.toDateString();
      });

      render(`
        <div class="container">
          <header class="header">
            <div class="logo">
              <div class="logo-icon">üçÖ</div>
              <span>Focus Tracker</span>
            </div>
            <div class="user-info">
              <span class="user-name">${currentUser.name}</span>
              <button class="btn btn-secondary" onclick="handleLogout()">Sign Out</button>
            </div>
          </header>

          <div class="status-card">
            <div class="status-icon">‚úÖ</div>
            <div class="status-title">Focus Tracking Active</div>
            <div class="status-subtitle">Your productivity is being monitored to help you stay focused</div>
          </div>

          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-value">${today.length}</div>
              <div class="stat-label">Screenshots Today</div>
            </div>
            <div class="stat-card">
              <div class="stat-value">${screenshots.length}</div>
              <div class="stat-label">Total Screenshots</div>
            </div>
            <div class="stat-card">
              <div class="stat-value">${today.length > 0 ? formatTime(today[0].captured_at) : '--'}</div>
              <div class="stat-label">Last Capture</div>
            </div>
          </div>

          <div class="main-content">
            <div class="content-header">
              <h2 class="content-title">Your Recent Activity</h2>
            </div>
            
            ${screenshots.length === 0 ? `
              <div class="empty-state">
                <div class="empty-state-icon">üì∏</div>
                <p>No screenshots yet. They'll appear here every 10 minutes.</p>
              </div>
            ` : `
              <div class="screenshot-grid">
                ${screenshots.slice(0, 20).map(s => `
                  <div class="screenshot-card">
                    <img class="screenshot-image" src="${s.imageUrl}" alt="Screenshot" onclick="openLightbox('${s.imageUrl}')">
                    <div class="screenshot-info">
                      <div class="screenshot-time">${formatDateTime(s.captured_at)}</div>
                      <div class="screenshot-url">${s.url || 'Unknown page'}</div>
                    </div>
                  </div>
                `).join('')}
              </div>
            `}
          </div>
        </div>
      `);
    }

    // Teacher Dashboard
    let selectedStudent = null;
    let students = [];

    async function showTeacherDashboard() {
      students = await fetchJSON('/api/admin/students');
      
      render(`
        <div class="container">
          <header class="header">
            <div class="logo">
              <div class="logo-icon">üçÖ</div>
              <span>Focus Tracker</span>
              <span style="background: var(--success); color: black; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; margin-left: 12px;">TEACHER</span>
            </div>
            <div class="user-info">
              <button class="btn btn-secondary" onclick="showScheduleEditor()" style="margin-right: 8px;">üìÖ Edit Schedule</button>
              <span class="user-name">${currentUser.name}</span>
              <button class="btn btn-secondary" onclick="handleLogout()">Sign Out</button>
            </div>
          </header>

          <div class="dashboard-grid">
            <div class="sidebar">
              <div class="sidebar-title">Students (${students.length})</div>
              <ul class="student-list" id="student-list">
                ${students.length === 0 ? `
                  <div class="empty-state" style="padding: 20px;">
                    <p style="font-size: 14px;">No students registered yet</p>
                  </div>
                ` : students.map((s, i) => `
                  <li class="student-item ${i === 0 ? 'active' : ''}" onclick="selectStudent(${s.id})" data-id="${s.id}">
                    <div class="student-item-name">${s.name}</div>
                    <div class="student-item-meta">${s.screenshot_count} screenshots</div>
                  </li>
                `).join('')}
              </ul>
            </div>

            <div class="main-content" id="student-content">
              ${students.length > 0 ? await getStudentContent(students[0].id) : `
                <div class="empty-state">
                  <div class="empty-state-icon">üë•</div>
                  <p>Waiting for students to register and install the extension.</p>
                </div>
              `}
            </div>
          </div>
        </div>
      `);

      if (students.length > 0) {
        selectedStudent = students[0].id;
      }
    }

    async function selectStudent(id) {
      selectedStudent = id;
      
      // Update active state
      document.querySelectorAll('.student-item').forEach(el => {
        el.classList.toggle('active', parseInt(el.dataset.id) === id);
      });

      // Load content
      document.getElementById('student-content').innerHTML = await getStudentContent(id);
    }

    async function getStudentContent(studentId) {
      const student = students.find(s => s.id === studentId);
      const screenshots = await fetchJSON(`/api/admin/students/${studentId}/screenshots`);

      return `
        <div class="content-header">
          <div>
            <h2 class="content-title">${student.name}</h2>
            <p style="color: var(--text-muted); margin-top: 4px;">${student.email}</p>
          </div>
          <div style="display: flex; align-items: center; gap: 12px;">
            <button class="btn btn-primary" onclick="requestScreenshot(${studentId})" id="request-btn-${studentId}">
              üì∏ Take Screenshot Now
            </button>
            <div style="text-align: right;">
              <div style="color: ${student.agreed_to_terms ? 'var(--success)' : 'var(--warning)'}; font-weight: 600;">
                ${student.agreed_to_terms ? '‚úì Terms Accepted' : '‚ö† Pending Agreement'}
              </div>
              ${student.last_screenshot ? `
                <div style="color: var(--text-muted); font-size: 13px; margin-top: 4px;">
                  Last active: ${formatDateTime(student.last_screenshot)}
                </div>
              ` : ''}
            </div>
          </div>
        </div>
        
        ${screenshots.length === 0 ? `
          <div class="empty-state">
            <div class="empty-state-icon">üì∏</div>
            <p>No screenshots from this student yet.</p>
          </div>
        ` : `
          <div class="screenshot-grid">
            ${screenshots.map(s => `
              <div class="screenshot-card" id="screenshot-${s.id}">
                <img class="screenshot-image" src="${s.imageUrl}" alt="Screenshot" onclick="openLightbox('${s.imageUrl}')">
                <div class="screenshot-info">
                  <div class="screenshot-time">${formatDateTime(s.captured_at)}</div>
                  <div class="screenshot-url" title="${s.url || ''}">${s.title || s.url || 'Unknown page'}</div>
                  <button class="btn-delete" onclick="deleteScreenshot(${s.id}, ${studentId})">üóëÔ∏è Delete</button>
                </div>
              </div>
            `).join('')}
          </div>
        `}
      `;
    }

    // Request screenshot from student
    async function requestScreenshot(studentId) {
      const btn = document.getElementById('request-btn-' + studentId);
      const originalText = btn.innerHTML;
      btn.innerHTML = '‚è≥ Requesting...';
      btn.disabled = true;

      try {
        await fetchJSON(`/api/admin/students/${studentId}/request-screenshot`, {
          method: 'POST'
        });
        btn.innerHTML = '‚úì Requested!';
        
        // Refresh after a few seconds to show new screenshot
        setTimeout(async () => {
          btn.innerHTML = originalText;
          btn.disabled = false;
          document.getElementById('student-content').innerHTML = await getStudentContent(studentId);
        }, 8000);
      } catch (err) {
        btn.innerHTML = '‚ùå Failed';
        setTimeout(() => {
          btn.innerHTML = originalText;
          btn.disabled = false;
        }, 2000);
      }
    }

    // Delete screenshot
    async function deleteScreenshot(screenshotId, studentId) {
      if (!confirm('Delete this screenshot?')) return;

      try {
        await fetchJSON(`/api/admin/screenshots/${screenshotId}`, {
          method: 'DELETE'
        });
        // Remove from DOM
        const card = document.getElementById('screenshot-' + screenshotId);
        if (card) {
          card.style.opacity = '0';
          card.style.transform = 'scale(0.8)';
          setTimeout(() => card.remove(), 300);
        }
      } catch (err) {
        alert('Failed to delete screenshot');
      }
    }

    // API Helpers
    async function fetchJSON(url, options = {}) {
      const res = await fetch(`${API_URL}${url}`, {
        ...options,
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${authToken}`,
          ...options.headers
        }
      });
      return res.json();
    }

    // Event Handlers
    async function handleLogin(e) {
      e.preventDefault();
      const email = document.getElementById('login-email').value;
      const password = document.getElementById('login-password').value;

      try {
        const res = await fetch(`${API_URL}/api/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });
        const data = await res.json();

        if (data.success) {
          authToken = data.token;
          localStorage.setItem('pomodoroToken', authToken);
          currentUser = data.user;
          
          // Notify extension of login
          notifyExtensionOfLogin(data.token, data.user);
          
          if (currentUser.role === 'teacher') {
            showTeacherDashboard();
          } else if (!currentUser.agreedToTerms) {
            showAgreementPage();
          } else {
            showStudentDashboard();
          }
        } else {
          showError(data.error || 'Login failed');
        }
      } catch (err) {
        showError('Connection failed. Please try again.');
      }
    }

    async function handleTeacherLogin(e) {
      e.preventDefault();
      const password = document.getElementById('teacher-password').value;

      try {
        const res = await fetch(`${API_URL}/api/teacher-login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ password })
        });
        const data = await res.json();

        if (data.success) {
          authToken = data.token;
          localStorage.setItem('pomodoroToken', authToken);
          currentUser = data.user;
          showTeacherDashboard();
        } else {
          showError(data.error || 'Invalid password');
        }
      } catch (err) {
        showError('Connection failed. Please try again.');
      }
    }

    async function handleRegister(e) {
      e.preventDefault();
      const name = document.getElementById('register-name').value;
      const email = document.getElementById('register-email').value;
      const password = document.getElementById('register-password').value;

      try {
        const res = await fetch(`${API_URL}/api/register`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, email, password })
        });
        const data = await res.json();

        if (data.success) {
          // Auto-login after registration
          await handleLogin({ preventDefault: () => {} });
          document.getElementById('login-email').value = email;
          document.getElementById('login-password').value = password;
        } else {
          showError(data.error || 'Registration failed');
        }
      } catch (err) {
        showError('Connection failed. Please try again.');
      }
    }

    async function handleAcceptTerms() {
      try {
        const res = await fetch(`${API_URL}/api/accept-terms`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${authToken}`
          }
        });
        const data = await res.json();

        if (data.success) {
          currentUser.agreedToTerms = true;
          showStudentDashboard();
        }
      } catch (err) {
        alert('Failed to save agreement. Please try again.');
      }
    }

    function handleLogout() {
      localStorage.removeItem('pomodoroToken');
      authToken = null;
      currentUser = null;
      showLoginPage();
    }

    function showError(msg) {
      const el = document.getElementById('error-msg');
      if (el) {
        el.textContent = msg;
        el.style.display = 'block';
      }
    }

    // Lightbox
    function openLightbox(src) {
      document.getElementById('lightbox-img').src = src;
      document.getElementById('lightbox').classList.add('visible');
    }

    function closeLightbox() {
      document.getElementById('lightbox').classList.remove('visible');
    }

    // Schedule Editor
    let currentSchedule = null;
    const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
    
    async function showScheduleEditor() {
      currentSchedule = await fetchJSON('/api/schedule');
      
      render(`
        <div class="container">
          <header class="header">
            <div class="logo">
              <div class="logo-icon">üçÖ</div>
              <span>Schedule Editor</span>
            </div>
            <div class="user-info">
              <button class="btn btn-secondary" onclick="showTeacherDashboard()">‚Üê Back to Dashboard</button>
            </div>
          </header>

          <div class="main-content">
            <div class="content-header">
              <h2 class="content-title">Edit Pomodoro Schedule</h2>
              <button class="btn btn-primary" onclick="saveSchedule()">üíæ Save Schedule</button>
            </div>
            
            <div style="margin-bottom: 24px;">
              <label class="form-label">Select Day</label>
              <select id="schedule-day" class="form-input" style="width: 200px;" onchange="renderDaySchedule()">
                ${days.map(d => `<option value="${d}">${d}</option>`).join('')}
              </select>
              <button class="btn btn-secondary" style="margin-left: 12px;" onclick="copyToAllDays()">Copy to All Days</button>
            </div>
            
            <div id="schedule-blocks"></div>
            
            <button class="btn btn-secondary" onclick="addBlock()" style="margin-top: 16px;">+ Add Time Block</button>
          </div>
        </div>
      `);
      
      renderDaySchedule();
    }
    
    function renderDaySchedule() {
      const day = document.getElementById('schedule-day').value;
      const blocks = currentSchedule[day] || [];
      
      document.getElementById('schedule-blocks').innerHTML = blocks.length === 0 ? `
        <div class="empty-state" style="padding: 40px;">
          <p>No blocks for ${day}. Click "Add Time Block" to create one.</p>
        </div>
      ` : blocks.map((block, i) => `
        <div class="schedule-block" style="display: flex; gap: 12px; align-items: center; margin-bottom: 12px; padding: 16px; background: var(--bg-elevated); border-radius: 12px;">
          <input type="text" value="${block.start}" placeholder="9:00 AM" 
            style="width: 100px; padding: 8px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; color: white;"
            onchange="updateBlock(${i}, 'start', this.value)">
          <span style="color: var(--text-muted);">to</span>
          <input type="text" value="${block.end}" placeholder="9:30 AM"
            style="width: 100px; padding: 8px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; color: white;"
            onchange="updateBlock(${i}, 'end', this.value)">
          <input type="text" value="${block.name}" placeholder="Block name"
            style="flex: 1; padding: 8px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; color: white;"
            onchange="updateBlock(${i}, 'name', this.value)">
          <button onclick="removeBlock(${i})" style="background: none; border: none; color: var(--accent); cursor: pointer; font-size: 18px;">üóëÔ∏è</button>
        </div>
      `).join('');
    }
    
    function updateBlock(index, field, value) {
      const day = document.getElementById('schedule-day').value;
      if (!currentSchedule[day]) currentSchedule[day] = [];
      currentSchedule[day][index][field] = value;
    }
    
    function addBlock() {
      const day = document.getElementById('schedule-day').value;
      if (!currentSchedule[day]) currentSchedule[day] = [];
      currentSchedule[day].push({ start: '', end: '', name: 'New Block' });
      renderDaySchedule();
    }
    
    function removeBlock(index) {
      const day = document.getElementById('schedule-day').value;
      currentSchedule[day].splice(index, 1);
      renderDaySchedule();
    }
    
    function copyToAllDays() {
      const day = document.getElementById('schedule-day').value;
      const blocks = JSON.parse(JSON.stringify(currentSchedule[day] || []));
      days.forEach(d => {
        currentSchedule[d] = JSON.parse(JSON.stringify(blocks));
      });
      alert('Schedule copied to all weekdays!');
    }
    
    async function saveSchedule() {
      try {
        await fetchJSON('/api/admin/schedule', {
          method: 'POST',
          body: JSON.stringify({ schedule: currentSchedule })
        });
        alert('Schedule saved! Students will see the new schedule when they reload.');
      } catch (err) {
        alert('Failed to save schedule');
      }
    }

    // Notify extension of login (so it can capture screenshots)
    function notifyExtensionOfLogin(token, user) {
      // Dispatch a custom event that the content script can catch
      window.dispatchEvent(new CustomEvent('pomodoroLogin', {
        detail: { token, user }
      }));
      
      // Also trigger storage event
      localStorage.setItem('pomodoroLoginTime', Date.now().toString());
    }

    // Formatters
    function formatDateTime(iso) {
      const d = new Date(iso);
      return d.toLocaleDateString('en-US', { 
        month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit'
      });
    }

    function formatTime(iso) {
      const d = new Date(iso);
      return d.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
    }

    // Start app
    init();
  </script>
</body>
</html>

